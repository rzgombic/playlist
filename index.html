<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Article Audio Playlist</title>

<style>
* {
  box-sizing: border-box;
}

:root {
  --bg-primary: #f5f5f5;
  --bg-secondary: white;
  --text-primary: #333;
  --text-secondary: #666;
  --text-tertiary: #999;
  --border-color: #ddd;
  --border-color-light: #ccc;
  --shadow: rgba(0,0,0,0.1);
  --item-hover: #f0f0f0;
  --delete-hover-bg: #fee;
  --delete-hover-border: #f88;
}

body.dark-mode {
  --bg-primary: #1a1a1a;
  --bg-secondary: #2d2d2d;
  --text-primary: #e0e0e0;
  --text-secondary: #a0a0a0;
  --text-tertiary: #707070;
  --border-color: #404040;
  --border-color-light: #505050;
  --shadow: rgba(0,0,0,0.3);
  --item-hover: #3a3a3a;
  --delete-hover-bg: #4a2020;
  --delete-hover-border: #8a4040;
}

body {
  background: var(--bg-primary);
  color: var(--text-primary);
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
  transition: background-color 0.3s, color 0.3s;
}

/* ---------- INPUT AREA ---------- */
#input-area {
  padding: 20px;
  background: var(--bg-secondary);
  border-bottom: 2px solid var(--border-color);
}

#text-input {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  border: 1px solid var(--border-color-light);
  border-radius: 4px;
  resize: vertical;
  min-height: 120px;
  font-family: inherit;
  background: var(--bg-secondary);
  color: var(--text-primary);
}

#add-btn {
  margin-top: 10px;
  padding: 10px 20px;
  font-size: 16px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

#add-btn:hover {
  background: #0056b3;
}

#add-btn:active {
  transform: scale(0.98);
}

/* ---------- PLAYLIST AREA ---------- */
#playlist-area {
  padding: 20px;
  padding-bottom: 120px;
}

#playlist {
  list-style: none;
  padding: 0;
  margin: 0;
}

.playlist-item {
  background: var(--bg-secondary);
  margin-bottom: 10px;
  padding: 15px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  gap: 10px;
  border: 1px solid var(--border-color);
}

.playlist-item.playing {
  background: #e3f2fd;
  border-color: #007bff;
  box-shadow: 0 2px 4px rgba(0,123,255,0.2);
}

.playlist-item.dragging {
  opacity: 0.4;
}

.drag-handle {
  font-size: 20px;
  color: var(--text-tertiary);
  cursor: grab;
  user-select: none;
  line-height: 1;
  padding: 10px;
  margin: -10px;
  touch-action: none;
}

.drag-handle:active {
  cursor: grabbing;
}

.item-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-width: 0;
}

.item-text {
  font-size: 14px;
  line-height: 1.5;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.item-duration {
  font-size: 12px;
  color: var(--text-secondary);
}

.item-progress {
  width: 100%;
  height: 4px;
  background: #e0e0e0;
  border-radius: 2px;
  overflow: hidden;
  display: none;
}

.playlist-item.playing .item-progress {
  display: block;
}

.item-progress-bar {
  height: 100%;
  background: #007bff;
  width: 0%;
  transition: width 0.3s linear;
}

.play-item-btn, .delete-btn {
  padding: 6px 10px;
  font-size: 12px;
  border: 1px solid var(--border-color-light);
  background: var(--bg-secondary);
  border-radius: 4px;
  cursor: pointer;
  white-space: nowrap;
  color: var(--text-primary);
}

.play-item-btn:hover {
  background: #e3f2fd;
  border-color: #007bff;
}

.delete-btn:hover {
  background: var(--delete-hover-bg);
  border-color: var(--delete-hover-border);
  color: #c00;
}

/* ---------- CONTROLS ---------- */
#controls {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg-secondary);
  border-top: 2px solid var(--border-color);
  padding: 15px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  box-shadow: 0 -2px 8px var(--shadow);
}

#dark-mode-toggle {
  position: absolute;
  left: 15px;
  width: 40px;
  height: 40px;
  font-size: 20px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color-light);
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  user-select: none;
}

.control-btn {
  width: 48px;
  height: 48px;
  font-size: 18px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color-light);
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  user-select: none;
  color: var(--text-primary);
}

.control-btn:hover, #dark-mode-toggle:hover {
  background: var(--item-hover);
}

.control-btn:active {
  transform: scale(0.95);
}

#play-pause-btn {
  width: 64px;
  height: 64px;
  font-size: 28px;
  background: #007bff;
  color: white;
  border-color: #007bff;
}

#play-pause-btn:hover {
  background: #0056b3;
}

#play-all-btn {
  padding: 10px 16px;
  font-size: 14px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 20px;
  cursor: pointer;
  white-space: nowrap;
}

#play-all-btn:hover {
  background: #218838;
}

#play-all-btn:active {
  transform: scale(0.98);
}
</style>
</head>

<body>

<!-- INPUT AREA -->
<div id="input-area">
  <textarea id="text-input" placeholder="Paste your article text here..."></textarea>
  <button id="add-btn">Add to Playlist</button>
</div>

<!-- PLAYLIST AREA -->
<div id="playlist-area">
  <ul id="playlist"></ul>
</div>

<!-- BOTTOM CONTROLS -->
<div id="controls">
  <button id="dark-mode-toggle" title="Toggle Dark Mode">üåô</button>
  <button id="prev-btn" class="control-btn" title="Previous">‚èÆ</button>
  <button id="play-pause-btn" title="Play/Pause">‚ñ∂</button>
  <button id="next-btn" class="control-btn" title="Next">‚è≠</button>
  <button id="play-all-btn" title="Play All">Play All</button>
</div>

<script>
const textInput = document.getElementById('text-input');
const addBtn = document.getElementById('add-btn');
const playlist = document.getElementById('playlist');
const playPauseBtn = document.getElementById('play-pause-btn');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');
const playAllBtn = document.getElementById('play-all-btn');
const darkModeToggle = document.getElementById('dark-mode-toggle');

let currentIndex = -1;
let items = [];
let isPlaying = false;
let progressInterval = null;
let startTime = 0;
let estimatedDuration = 0;
let pausedAt = 0;
let elapsedBeforePause = 0;

// ---------- LOCALSTORAGE ----------
function saveToStorage() {
  localStorage.setItem('playlist-items', JSON.stringify(items));
}

function loadFromStorage() {
  const saved = localStorage.getItem('playlist-items');
  if (saved) {
    try {
      items = JSON.parse(saved);
    } catch (e) {
      items = [];
    }
  }
}

function saveDarkMode(isDark) {
  localStorage.setItem('dark-mode', isDark ? 'true' : 'false');
}

function loadDarkMode() {
  const saved = localStorage.getItem('dark-mode');
  return saved === 'true';
}

// ---------- DARK MODE ----------
function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  darkModeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  saveDarkMode(isDark);
}

darkModeToggle.addEventListener('click', toggleDarkMode);

// Initialize dark mode from storage
if (loadDarkMode()) {
  document.body.classList.add('dark-mode');
  darkModeToggle.textContent = '‚òÄÔ∏è';
}

// ---------- ADD ITEM ----------
addBtn.addEventListener('click', () => {
  const text = textInput.value.trim();
  if (!text) return;
  
  items.push(text);
  saveToStorage();
  renderPlaylist();
  textInput.value = '';
  textInput.focus();
});

// ---------- RENDER PLAYLIST ----------
function renderPlaylist() {
  playlist.innerHTML = '';
  
  items.forEach((text, index) => {
    const li = document.createElement('li');
    li.className = 'playlist-item';
    li.draggable = true;
    li.dataset.index = index;
    
    if (index === currentIndex) {
      li.classList.add('playing');
    }
    
    // Drag handle
    const handle = document.createElement('span');
    handle.className = 'drag-handle';
    handle.textContent = '‚ò∞';
    
    // Item content container
    const itemContent = document.createElement('div');
    itemContent.className = 'item-content';
    
    // Item text
    const itemText = document.createElement('div');
    itemText.className = 'item-text';
    itemText.textContent = text;
    
    // Duration
    const duration = calculateDuration(text);
    const durationEl = document.createElement('div');
    durationEl.className = 'item-duration';
    durationEl.textContent = formatDuration(duration);
    
    // Progress bar
    const progressContainer = document.createElement('div');
    progressContainer.className = 'item-progress';
    const progressBar = document.createElement('div');
    progressBar.className = 'item-progress-bar';
    progressContainer.appendChild(progressBar);
    
    itemContent.appendChild(itemText);
    itemContent.appendChild(durationEl);
    itemContent.appendChild(progressContainer);
    
    // Play button
    const playBtn = document.createElement('button');
    playBtn.className = 'play-item-btn';
    playBtn.textContent = '‚ñ∂ Play';
    playBtn.addEventListener('click', () => playItem(index));
    
    // Delete button
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-btn';
    deleteBtn.textContent = '‚úï';
    deleteBtn.addEventListener('click', () => deleteItem(index));
    
    li.appendChild(handle);
    li.appendChild(itemContent);
    li.appendChild(playBtn);
    li.appendChild(deleteBtn);
    
    // Drag events
    li.addEventListener('dragstart', handleDragStart);
    li.addEventListener('dragover', handleDragOver);
    li.addEventListener('drop', handleDrop);
    li.addEventListener('dragend', handleDragEnd);
    
    playlist.appendChild(li);
  });
}

// ---------- DRAG AND DROP ----------
let draggedIndex = null;

function handleDragStart(e) {
  draggedIndex = parseInt(e.target.dataset.index);
  e.target.classList.add('dragging');
}

function handleDragOver(e) {
  e.preventDefault();
}

function handleDrop(e) {
  e.preventDefault();
  const dropIndex = parseInt(e.currentTarget.dataset.index);
  
  if (draggedIndex !== null && draggedIndex !== dropIndex) {
    // Reorder array
    const [draggedItem] = items.splice(draggedIndex, 1);
    items.splice(dropIndex, 0, draggedItem);
    
    // Update current index
    if (currentIndex === draggedIndex) {
      currentIndex = dropIndex;
    } else if (draggedIndex < currentIndex && dropIndex >= currentIndex) {
      currentIndex--;
    } else if (draggedIndex > currentIndex && dropIndex <= currentIndex) {
      currentIndex++;
    }
    
    saveToStorage();
    renderPlaylist();
  }
}

function handleDragEnd(e) {
  e.target.classList.remove('dragging');
  draggedIndex = null;
}

// ---------- TOUCH DRAG SUPPORT (for mobile Safari) ----------
let touchStartY = 0;
let touchStartX = 0;
let touchedElement = null;
let placeholder = null;

playlist.addEventListener('touchstart', (e) => {
  const handle = e.target.closest('.drag-handle');
  if (!handle) return;
  
  const item = handle.closest('.playlist-item');
  if (!item) return;
  
  touchedElement = item;
  touchStartY = e.touches[0].clientY;
  touchStartX = e.touches[0].clientX;
  
  // Create placeholder
  placeholder = item.cloneNode(true);
  placeholder.style.opacity = '0.4';
  placeholder.style.pointerEvents = 'none';
  
  item.style.opacity = '0.4';
}, { passive: true });

playlist.addEventListener('touchmove', (e) => {
  if (!touchedElement) return;
  
  e.preventDefault(); // Prevent scrolling while dragging
  
  const touch = e.touches[0];
  const currentY = touch.clientY;
  
  // Find the item we're hovering over
  const items = Array.from(playlist.querySelectorAll('.playlist-item'));
  const targetItem = items.find(item => {
    if (item === touchedElement) return false;
    const rect = item.getBoundingClientRect();
    return currentY >= rect.top && currentY <= rect.bottom;
  });
  
  if (targetItem) {
    const rect = targetItem.getBoundingClientRect();
    const middle = rect.top + rect.height / 2;
    
    if (currentY < middle) {
      playlist.insertBefore(touchedElement, targetItem);
    } else {
      playlist.insertBefore(touchedElement, targetItem.nextSibling);
    }
  }
}, { passive: false });

playlist.addEventListener('touchend', (e) => {
  if (!touchedElement) return;
  
  touchedElement.style.opacity = '1';
  
  // Rebuild items array based on new DOM order
  const newItems = [];
  const itemElements = playlist.querySelectorAll('.playlist-item');
  itemElements.forEach(el => {
    const index = parseInt(el.dataset.index);
    newItems.push(items[index]);
  });
  
  // Find new position of currently playing item
  if (currentIndex >= 0) {
    const playingText = items[currentIndex];
    currentIndex = newItems.indexOf(playingText);
  }
  
  items = newItems;
  saveToStorage();
  renderPlaylist();
  
  touchedElement = null;
  placeholder = null;
}, { passive: true });

playlist.addEventListener('touchcancel', (e) => {
  if (touchedElement) {
    touchedElement.style.opacity = '1';
    touchedElement = null;
    placeholder = null;
  }
}, { passive: true });

// ---------- DELETE ITEM ----------
function deleteItem(index) {
  if (index === currentIndex) {
    stop();
  } else if (index < currentIndex) {
    currentIndex--;
  }
  
  items.splice(index, 1);
  saveToStorage();
  renderPlaylist();
}

// ---------- PLAY ITEM ----------
function playItem(index) {
  if (index < 0 || index >= items.length) return;
  
  stop();
  currentIndex = index;
  speak(items[index]);
  renderPlaylist();
}

// ---------- PLAY ALL ----------
playAllBtn.addEventListener('click', () => {
  if (items.length === 0) return;
  playItem(0);
});

// ---------- DURATION CALCULATION ----------
function calculateDuration(text) {
  // Average speaking rate: ~150 words per minute at 1.0 rate
  const words = text.trim().split(/\s+/).length;
  const minutes = words / 150;
  return minutes * 60; // return seconds
}

function formatDuration(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  if (mins === 0) {
    return `${secs} sec`;
  }
  return `${mins} min ${secs} sec`;
}

// ---------- PROGRESS TRACKING ----------
function updateProgress() {
  if (currentIndex < 0) return;
  
  const currentElapsed = (Date.now() - startTime) / 1000;
  const elapsed = elapsedBeforePause + currentElapsed;
  const progress = Math.min((elapsed / estimatedDuration) * 100, 100);
  
  const playingItem = playlist.querySelector('.playlist-item.playing');
  if (playingItem) {
    const progressBar = playingItem.querySelector('.item-progress-bar');
    if (progressBar) {
      progressBar.style.width = progress + '%';
    }
  }
}

function startProgressTracking() {
  if (progressInterval) {
    clearInterval(progressInterval);
  }
  startTime = Date.now();
  progressInterval = setInterval(updateProgress, 100);
}

function stopProgressTracking(resetBar = true) {
  if (progressInterval) {
    clearInterval(progressInterval);
    progressInterval = null;
  }
  // Reset progress bar only if requested
  if (resetBar) {
    elapsedBeforePause = 0;
    const progressBars = playlist.querySelectorAll('.item-progress-bar');
    progressBars.forEach(bar => bar.style.width = '0%');
  }
}

// ---------- SPEECH SYNTHESIS ----------
function speak(text) {
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = 1.0;
  
  estimatedDuration = calculateDuration(text);
  elapsedBeforePause = 0; // Reset for new item
  
  utterance.onstart = () => {
    isPlaying = true;
    playPauseBtn.textContent = '‚ùö‚ùö';
    startProgressTracking();
  };
  
  utterance.onend = () => {
    stopProgressTracking();
    // Auto-play next
    if (currentIndex < items.length - 1) {
      playItem(currentIndex + 1);
    } else {
      stop();
    }
  };
  
  speechSynthesis.speak(utterance);
}

function stop() {
  speechSynthesis.cancel();
  stopProgressTracking();
  isPlaying = false;
  playPauseBtn.textContent = '‚ñ∂';
  currentIndex = -1;
  renderPlaylist();
}

// ---------- CONTROL BUTTONS ----------
playPauseBtn.addEventListener('click', () => {
  if (speechSynthesis.speaking && !speechSynthesis.paused) {
    speechSynthesis.pause();
    // Save elapsed time before stopping progress tracking
    const currentElapsed = (Date.now() - startTime) / 1000;
    elapsedBeforePause += currentElapsed;
    stopProgressTracking(false); // Don't reset the progress bar
    playPauseBtn.textContent = '‚ñ∂';
  } else if (speechSynthesis.paused) {
    speechSynthesis.resume();
    startProgressTracking();
    playPauseBtn.textContent = '‚ùö‚ùö';
  } else {
    // Start playing from current or first item
    const startIndex = currentIndex >= 0 ? currentIndex : 0;
    if (items.length > 0) {
      playItem(startIndex);
    }
  }
});

prevBtn.addEventListener('click', () => {
  if (currentIndex > 0) {
    playItem(currentIndex - 1);
  }
});

nextBtn.addEventListener('click', () => {
  if (currentIndex < items.length - 1) {
    playItem(currentIndex + 1);
  }
});

// Initial render
loadFromStorage();
renderPlaylist();
</script>

</body>
</html>
