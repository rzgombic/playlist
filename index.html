<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Article Audio Playlist</title>

<style>
* {
  box-sizing: border-box;
}

body {
  background: #f5f5f5;
  color: #333;
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
}

/* ---------- INPUT AREA ---------- */
#input-area {
  padding: 20px;
  background: white;
  border-bottom: 2px solid #ddd;
}

#text-input {
  width: 100%;
  padding: 12px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 4px;
  resize: vertical;
  min-height: 120px;
  font-family: inherit;
}

#add-btn {
  margin-top: 10px;
  padding: 10px 20px;
  font-size: 14px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

#add-btn:hover {
  background: #0056b3;
}

#add-btn:active {
  transform: scale(0.98);
}

/* ---------- PLAYLIST AREA ---------- */
#playlist-area {
  padding: 20px;
  padding-bottom: 120px;
}

#playlist {
  list-style: none;
  padding: 0;
  margin: 0;
}

.playlist-item {
  background: white;
  margin-bottom: 10px;
  padding: 15px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  gap: 10px;
  border: 1px solid #ddd;
}

.playlist-item.playing {
  background: #e3f2fd;
  border-color: #007bff;
  box-shadow: 0 2px 4px rgba(0,123,255,0.2);
}

.playlist-item.dragging {
  opacity: 0.4;
}

.drag-handle {
  font-size: 20px;
  color: #999;
  cursor: grab;
  user-select: none;
  line-height: 1;
}

.drag-handle:active {
  cursor: grabbing;
}

.item-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-width: 0;
}

.item-text {
  font-size: 14px;
  line-height: 1.5;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.item-duration {
  font-size: 12px;
  color: #666;
}

.item-progress {
  width: 100%;
  height: 4px;
  background: #e0e0e0;
  border-radius: 2px;
  overflow: hidden;
  display: none;
}

.playlist-item.playing .item-progress {
  display: block;
}

.item-progress-bar {
  height: 100%;
  background: #007bff;
  width: 0%;
  transition: width 0.3s linear;
}

.play-item-btn, .delete-btn {
  padding: 6px 10px;
  font-size: 12px;
  border: 1px solid #ccc;
  background: white;
  border-radius: 4px;
  cursor: pointer;
  white-space: nowrap;
}

.play-item-btn:hover {
  background: #e3f2fd;
  border-color: #007bff;
}

.delete-btn:hover {
  background: #fee;
  border-color: #f88;
  color: #c00;
}

/* ---------- CONTROLS ---------- */
#controls {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  border-top: 2px solid #ddd;
  padding: 15px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
}

.control-btn {
  width: 48px;
  height: 48px;
  font-size: 18px;
  background: white;
  border: 1px solid #ccc;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  user-select: none;
}

.control-btn:hover {
  background: #f0f0f0;
}

.control-btn:active {
  transform: scale(0.95);
}

#play-pause-btn {
  width: 64px;
  height: 64px;
  font-size: 28px;
  background: #007bff;
  color: white;
  border-color: #007bff;
}

#play-pause-btn:hover {
  background: #0056b3;
}

#play-all-btn {
  padding: 10px 16px;
  font-size: 14px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 20px;
  cursor: pointer;
  white-space: nowrap;
}

#play-all-btn:hover {
  background: #218838;
}

#play-all-btn:active {
  transform: scale(0.98);
}
</style>
</head>

<body>

<!-- INPUT AREA -->
<div id="input-area">
  <textarea id="text-input" placeholder="Paste your article text here..."></textarea>
  <button id="add-btn">Add to Playlist</button>
</div>

<!-- PLAYLIST AREA -->
<div id="playlist-area">
  <ul id="playlist"></ul>
</div>

<!-- BOTTOM CONTROLS -->
<div id="controls">
  <button id="prev-btn" class="control-btn" title="Previous">⏮</button>
  <button id="play-pause-btn" title="Play/Pause">▶</button>
  <button id="next-btn" class="control-btn" title="Next">⏭</button>
  <button id="play-all-btn" title="Play All">Play All</button>
</div>

<script>
const textInput = document.getElementById('text-input');
const addBtn = document.getElementById('add-btn');
const playlist = document.getElementById('playlist');
const playPauseBtn = document.getElementById('play-pause-btn');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');
const playAllBtn = document.getElementById('play-all-btn');

let currentIndex = -1;
let items = [];
let isPlaying = false;
let progressInterval = null;
let startTime = 0;
let estimatedDuration = 0;
let pausedAt = 0;
let elapsedBeforePause = 0;

// ---------- ADD ITEM ----------
addBtn.addEventListener('click', () => {
  const text = textInput.value.trim();
  if (!text) return;
  
  items.push(text);
  renderPlaylist();
  textInput.value = '';
  textInput.focus();
});

// ---------- RENDER PLAYLIST ----------
function renderPlaylist() {
  playlist.innerHTML = '';
  
  items.forEach((text, index) => {
    const li = document.createElement('li');
    li.className = 'playlist-item';
    li.draggable = true;
    li.dataset.index = index;
    
    if (index === currentIndex) {
      li.classList.add('playing');
    }
    
    // Drag handle
    const handle = document.createElement('span');
    handle.className = 'drag-handle';
    handle.textContent = '☰';
    
    // Item content container
    const itemContent = document.createElement('div');
    itemContent.className = 'item-content';
    
    // Item text
    const itemText = document.createElement('div');
    itemText.className = 'item-text';
    itemText.textContent = text;
    
    // Duration
    const duration = calculateDuration(text);
    const durationEl = document.createElement('div');
    durationEl.className = 'item-duration';
    durationEl.textContent = formatDuration(duration);
    
    // Progress bar
    const progressContainer = document.createElement('div');
    progressContainer.className = 'item-progress';
    const progressBar = document.createElement('div');
    progressBar.className = 'item-progress-bar';
    progressContainer.appendChild(progressBar);
    
    itemContent.appendChild(itemText);
    itemContent.appendChild(durationEl);
    itemContent.appendChild(progressContainer);
    
    // Play button
    const playBtn = document.createElement('button');
    playBtn.className = 'play-item-btn';
    playBtn.textContent = '▶ Play';
    playBtn.addEventListener('click', () => playItem(index));
    
    // Delete button
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-btn';
    deleteBtn.textContent = '✕';
    deleteBtn.addEventListener('click', () => deleteItem(index));
    
    li.appendChild(handle);
    li.appendChild(itemContent);
    li.appendChild(playBtn);
    li.appendChild(deleteBtn);
    
    // Drag events
    li.addEventListener('dragstart', handleDragStart);
    li.addEventListener('dragover', handleDragOver);
    li.addEventListener('drop', handleDrop);
    li.addEventListener('dragend', handleDragEnd);
    
    playlist.appendChild(li);
  });
}

// ---------- DRAG AND DROP ----------
let draggedIndex = null;

function handleDragStart(e) {
  draggedIndex = parseInt(e.target.dataset.index);
  e.target.classList.add('dragging');
}

function handleDragOver(e) {
  e.preventDefault();
}

function handleDrop(e) {
  e.preventDefault();
  const dropIndex = parseInt(e.currentTarget.dataset.index);
  
  if (draggedIndex !== null && draggedIndex !== dropIndex) {
    // Reorder array
    const [draggedItem] = items.splice(draggedIndex, 1);
    items.splice(dropIndex, 0, draggedItem);
    
    // Update current index
    if (currentIndex === draggedIndex) {
      currentIndex = dropIndex;
    } else if (draggedIndex < currentIndex && dropIndex >= currentIndex) {
      currentIndex--;
    } else if (draggedIndex > currentIndex && dropIndex <= currentIndex) {
      currentIndex++;
    }
    
    renderPlaylist();
  }
}

function handleDragEnd(e) {
  e.target.classList.remove('dragging');
  draggedIndex = null;
}

// ---------- DELETE ITEM ----------
function deleteItem(index) {
  if (index === currentIndex) {
    stop();
  } else if (index < currentIndex) {
    currentIndex--;
  }
  
  items.splice(index, 1);
  renderPlaylist();
}

// ---------- PLAY ITEM ----------
function playItem(index) {
  if (index < 0 || index >= items.length) return;
  
  stop();
  currentIndex = index;
  speak(items[index]);
  renderPlaylist();
}

// ---------- PLAY ALL ----------
playAllBtn.addEventListener('click', () => {
  if (items.length === 0) return;
  playItem(0);
});

// ---------- DURATION CALCULATION ----------
function calculateDuration(text) {
  // Average speaking rate: ~150 words per minute at 1.0 rate
  const words = text.trim().split(/\s+/).length;
  const minutes = words / 150;
  return minutes * 60; // return seconds
}

function formatDuration(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  if (mins === 0) {
    return `${secs} sec`;
  }
  return `${mins} min ${secs} sec`;
}

// ---------- PROGRESS TRACKING ----------
function updateProgress() {
  if (currentIndex < 0) return;
  
  const currentElapsed = (Date.now() - startTime) / 1000;
  const elapsed = elapsedBeforePause + currentElapsed;
  const progress = Math.min((elapsed / estimatedDuration) * 100, 100);
  
  const playingItem = playlist.querySelector('.playlist-item.playing');
  if (playingItem) {
    const progressBar = playingItem.querySelector('.item-progress-bar');
    if (progressBar) {
      progressBar.style.width = progress + '%';
    }
  }
}

function startProgressTracking() {
  if (progressInterval) {
    clearInterval(progressInterval);
  }
  startTime = Date.now();
  progressInterval = setInterval(updateProgress, 100);
}

function stopProgressTracking(resetBar = true) {
  if (progressInterval) {
    clearInterval(progressInterval);
    progressInterval = null;
  }
  // Reset progress bar only if requested
  if (resetBar) {
    elapsedBeforePause = 0;
    const progressBars = playlist.querySelectorAll('.item-progress-bar');
    progressBars.forEach(bar => bar.style.width = '0%');
  }
}

// ---------- MEDIA SESSION API ----------
function updateMediaSession(text, index) {
  if ('mediaSession' in navigator) {
    // Set metadata
    navigator.mediaSession.metadata = new MediaMetadata({
      title: text.substring(0, 100) + (text.length > 100 ? '...' : ''),
      artist: 'Article Audio Playlist',
      album: `Track ${index + 1} of ${items.length}`,
      artwork: [
        { src: 'https://via.placeholder.com/96x96.png?text=Audio', sizes: '96x96', type: 'image/png' },
        { src: 'https://via.placeholder.com/128x128.png?text=Audio', sizes: '128x128', type: 'image/png' },
        { src: 'https://via.placeholder.com/192x192.png?text=Audio', sizes: '192x192', type: 'image/png' },
        { src: 'https://via.placeholder.com/256x256.png?text=Audio', sizes: '256x256', type: 'image/png' },
        { src: 'https://via.placeholder.com/384x384.png?text=Audio', sizes: '384x384', type: 'image/png' },
        { src: 'https://via.placeholder.com/512x512.png?text=Audio', sizes: '512x512', type: 'image/png' },
      ]
    });

    // Set action handlers
    navigator.mediaSession.setActionHandler('play', () => {
      if (speechSynthesis.paused) {
        speechSynthesis.resume();
        startProgressTracking();
        playPauseBtn.textContent = '❚❚';
      } else if (!speechSynthesis.speaking && items.length > 0) {
        const startIndex = currentIndex >= 0 ? currentIndex : 0;
        playItem(startIndex);
      }
    });

    navigator.mediaSession.setActionHandler('pause', () => {
      if (speechSynthesis.speaking && !speechSynthesis.paused) {
        speechSynthesis.pause();
        const currentElapsed = (Date.now() - startTime) / 1000;
        elapsedBeforePause += currentElapsed;
        stopProgressTracking(false);
        playPauseBtn.textContent = '▶';
      }
    });

    navigator.mediaSession.setActionHandler('previoustrack', () => {
      if (currentIndex > 0) {
        playItem(currentIndex - 1);
      }
    });

    navigator.mediaSession.setActionHandler('nexttrack', () => {
      if (currentIndex < items.length - 1) {
        playItem(currentIndex + 1);
      }
    });

    navigator.mediaSession.setActionHandler('stop', () => {
      stop();
    });
  }
}

// ---------- SPEECH SYNTHESIS ----------
function speak(text) {
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = 1.0;
  
  estimatedDuration = calculateDuration(text);
  elapsedBeforePause = 0; // Reset for new item
  
  // Update media session with current track info
  updateMediaSession(text, currentIndex);
  
  utterance.onstart = () => {
    isPlaying = true;
    playPauseBtn.textContent = '❚❚';
    startProgressTracking();
    
    // Update playback state for media controls
    if ('mediaSession' in navigator) {
      navigator.mediaSession.playbackState = 'playing';
    }
  };
  
  utterance.onend = () => {
    stopProgressTracking();
    // Auto-play next
    if (currentIndex < items.length - 1) {
      playItem(currentIndex + 1);
    } else {
      stop();
    }
  };
  
  speechSynthesis.speak(utterance);
}

function stop() {
  speechSynthesis.cancel();
  stopProgressTracking();
  isPlaying = false;
  playPauseBtn.textContent = '▶';
  
  // Update media session playback state
  if ('mediaSession' in navigator) {
    navigator.mediaSession.playbackState = 'none';
  }
  
  currentIndex = -1;
  renderPlaylist();
}

// ---------- CONTROL BUTTONS ----------
playPauseBtn.addEventListener('click', () => {
  if (speechSynthesis.speaking && !speechSynthesis.paused) {
    speechSynthesis.pause();
    // Save elapsed time before stopping progress tracking
    const currentElapsed = (Date.now() - startTime) / 1000;
    elapsedBeforePause += currentElapsed;
    stopProgressTracking(false); // Don't reset the progress bar
    playPauseBtn.textContent = '▶';
  } else if (speechSynthesis.paused) {
    speechSynthesis.resume();
    startProgressTracking();
    playPauseBtn.textContent = '❚❚';
  } else {
    // Start playing from current or first item
    const startIndex = currentIndex >= 0 ? currentIndex : 0;
    if (items.length > 0) {
      playItem(startIndex);
    }
  }
});

prevBtn.addEventListener('click', () => {
  if (currentIndex > 0) {
    playItem(currentIndex - 1);
  }
});

nextBtn.addEventListener('click', () => {
  if (currentIndex < items.length - 1) {
    playItem(currentIndex + 1);
  }
});

// Initial render
renderPlaylist();
</script>

</body>
</html>
